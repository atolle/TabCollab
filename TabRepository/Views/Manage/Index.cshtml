@model ManageViewModel
@{
    ViewData["Title"] = "Manage your account";
}

<h2>@ViewData["Title"].</h2>
<p class="text-success">@ViewData["StatusMessage"]</p>

<div id="page">
    <div>
        <h4>Change your account settings</h4>
        <hr />
        <div class="panel panel-default panel-profile">
            <div id="profile-image" class="panel-heading" style="background-image: url('@Model.ImageFilePath');"></div>
            <div class="panel-body text-center">
                <h3>@Model.Username</h3>
            </div>
        </div>
        <form id="project-form" asp-controller="Manage" asp-action="SaveProfileImage" data-ajax="true" data-ajax-method="POST">
            @Html.ValidationSummary() <!--Prints list of validation errors at top of form-->
            <div class="form-group">
                @Html.LabelFor(m => m.Image)
                @Html.TextBoxFor(m => m.Image, new { type = "file", @class = "btn btn-default" })
                @Html.ValidationMessageFor(m => m.Image)
            </div>
            <button type="submit" class="btn btn-primary button-save disabled" form="project-form"> Save</button>
        </form>
        @if (Model.HasPassword)
        {
            <a asp-controller="Manage" asp-action="ChangePassword" class="btn btn-default">Change Password</a>
        }
        else
        {
            <a asp-controller="Manage" asp-action="SetPassword" class="btn btn-default">Create Password</a>
        }
    </div>
</div>
@section scripts
    {
    <script>
        var submitButton = $('.button-save');

        $("#Image").on("change", function (e, data) {
            submitButton[0].classList.remove("disabled");
        });

        $("#page").on("submit", function (e, data) {
            e.preventDefault();

            var form = e.target;
            var formData = new FormData(form);

            // Show spinner on save button
            //$($(document.activeElement)[0]).html('<div class="loader"></div>');

            var submitButtonHtml = submitButton.html();
            // Show spinner on submit button and disable it
            submitButton.html('<div class="loader"></div>');

            $.ajax({
                url: form.action,
                type: 'POST',
                data: formData,
                cache: false,
                contentType: false,
                processData: false
            })
                .then(function (response) {
                    submitButton.html(submitButtonHtml);
                    $("#profile-image").css("background-image", "url(" + response.imageFilePath + ")");
                })
                .fail(function (error) {
                    bootbox.alert("Unable to save profile image. Error: " + error.statusText);
                    submitButton.html(submitButtonHtml);
                })
        });
    </script>
}
