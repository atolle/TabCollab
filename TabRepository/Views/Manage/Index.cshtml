@model ManageViewModel
@{
    ViewData["Title"] = "Account";
}

<div class="container">
    <div id="page">
        <div class="manage-wrapper">
            <div class="row">
                <div class="col-md-6">
                    <div style="margin-bottom: 10px;">
                        <div class="card card-profile">
                            <div id="profile-image" class="card-header" style="background-image: url('@Model.ImageFilePath');"></div>
                            <div class="card-body text-center">
                                <h3>@Model.Username</h3>
                            </div>
                        </div>
                        <form id="project-form" asp-controller="Manage" asp-action="SaveProfileImage" data-ajax="true" data-ajax-method="POST">
                            @Html.ValidationSummary() <!--Prints list of validation errors at top of form-->
                            <div class="form-group">
                                @Html.LabelFor(m => m.Image)
                                @Html.TextBoxFor(m => m.Image, new { type = "file", @class = "btn btn-default", @style = "display: block" })
                                @Html.ValidationMessageFor(m => m.Image)
                            </div>
                            <button type="submit" class="btn btn-primary button-save disabled" form="project-form"> Save</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-6">
                    @if (Model.SubsriptionExpiration == null)
                    {
                        <h3>Free Account</h3>
                        <h5>Total Tab Versions: @Model.TabVersionCount</h5>
                        int tabsRemaining = 50 - Model.TabVersionCount;
                        string color = "inherit";
                        if (tabsRemaining <= 10)
                        {
                            color = "yellow";
                        }
                        if (tabsRemaining <= 0)
                        {
                            color = "red";
                        }
                        <h5 style="color: @color;">@(tabsRemaining) tab versions remaining</h5>
                        <a asp-controller="Manage" asp-action="AddSubscription" class="btn btn-default">Upgrade Account</a>
                    }
                    else
                    {
                        <h3>Subscription Account</h3>
                        <h5>Subscription Expiration: @Model.SubsriptionExpiration.Value.ToString("MM/dd/yyyy")</h5>
                        int daysLeft = ((int)(Model.SubsriptionExpiration - DateTime.Now).Value.TotalDays);
                        @if (daysLeft >= 0)
                        {
                            string color = daysLeft <= 30 ? "yellow" : "inherit";
                            <h5 style="color: @color;">@(daysLeft.ToString()) days left</h5>
                        }
                        else
                        {
                            <h5 style="color: red;">Subscription expired</h5>
                        }

                        <a asp-controller="Manage" asp-action="RenewSubscription" class="btn btn-default">Renew Subscription</a>
                    }
                    @if (Model.HasPassword)
                    {
                        <a asp-controller="Manage" asp-action="ChangePassword" class="btn btn-default">Change Password</a>
                    }
                    else
                    {
                        <a asp-controller="Manage" asp-action="SetPassword" class="btn btn-default">Create Password</a>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script>
        $(document).ready(function () {
            $('footer').show();

            var submitButton = $('.button-save');

            $("#Image").on("change", function (e, data) {
                // Make sure the image size is less than 1MB
                if (this.files[0].size > 1000000) {
                    if (!$(".file-validation").length) {
                        $(".validation-summary-valid ul").append("<li class='file-validation'>Image size limit is 1 MB.</li>");
                    }
                }
                else {
                    if ($(".file-validation").length) {
                        $(".file-validation").remove();
                    }
                    submitButton[0].classList.remove("disabled");
                }
            });

            $("#page").on("submit", function (e, data) {
                e.preventDefault();

                if (submitButton[0].classList.contains("disabled")) {
                    return;
                }

                var form = e.target;
                var formData = new FormData(form);

                var submitButtonHtml = submitButton.html();
                // Show spinner on submit button and disable it
                submitButton.html('<div class="loader"></div>');

                $.ajax({
                    url: form.action,
                    type: 'POST',
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false
                })
                    .then(function (response) {
                        submitButton.html(submitButtonHtml);
                        $("#profile-image").css("background-image", "url(" + response.imageFilePath + ")");
                        form.reset();
                        submitButton[0].classList.add("disabled");
                    })
                    .fail(function (error) {
                        bootbox.alert("Unable to save profile image. Error: " + error.statusText);
                        submitButton.html(submitButtonHtml);
                    })
            });
        });
    </script>
}
